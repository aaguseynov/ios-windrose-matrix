<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ç–ª–∞–¥–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</title>
    <script src="https://aaguseynov.github.io/ios-windrose-matrix/env-vars.js"></script>
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 600;
        }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover { background: #3367d6; }
        .debug-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #ddd;
        }
        .debug-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-family: monospace;
            font-size: 14px;
        }
        .debug-pass { border-left: 4px solid #28a745; }
        .debug-fail { border-left: 4px solid #dc3545; }
        .debug-warning { border-left: 4px solid #ffc107; }
        .json-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç –û—Ç–ª–∞–¥–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h1>
        
        <div id="status" class="status info">
            –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...
        </div>
        
        <div class="debug-section">
            <h3>üß™ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h3>
            <button onclick="runFullDiagnostic()">üîç –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</button>
            <button onclick="checkAuthState()">üîë –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é</button>
            <button onclick="checkLocalStorage()">üíæ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å localStorage</button>
            <button onclick="clearAll()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
        </div>
        
        <div id="diagnostic-results"></div>
        
        <div class="debug-section">
            <h3>üìù –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <div id="detailed-info" class="json-display">
                –ù–∞–∂–º–∏—Ç–µ "–ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞" –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
            </div>
        </div>
    </div>

    <script>
        let authService = null;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                updateStatus('‚è≥ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...', 'info');
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                const initialized = await window.authService.initialize(config);
                
                if (initialized) {
                    updateStatus('‚úÖ AuthService –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'success');
                    authService = window.authService;
                } else {
                    updateStatus('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ AuthService', 'error');
                }
                
            } catch (error) {
                updateStatus('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        });
        
        function updateStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function addDebugItem(title, status, details) {
            const resultsEl = document.getElementById('diagnostic-results');
            const item = document.createElement('div');
            item.className = `debug-item debug-${status}`;
            item.innerHTML = `
                <strong>${title}</strong><br>
                ${details}
            `;
            resultsEl.appendChild(item);
        }
        
        function updateDetailedInfo(data) {
            const infoEl = document.getElementById('detailed-info');
            infoEl.textContent = JSON.stringify(data, null, 2);
        }
        
        async function runFullDiagnostic() {
            document.getElementById('diagnostic-results').innerHTML = '';
            
            const diagnostic = {
                timestamp: new Date().toISOString(),
                environment: {},
                authService: {},
                localStorage: {},
                config: {},
                errors: []
            };
            
            try {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
                diagnostic.environment = {
                    hasWindow: typeof window !== 'undefined',
                    hasGoogle: typeof google !== 'undefined',
                    hasAuthService: typeof window.authService !== 'undefined',
                    userAgent: navigator.userAgent,
                    url: window.location.href
                };
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
                diagnostic.config = {
                    hasConfig: typeof config !== 'undefined',
                    clientId: config ? config.clientId : 'undefined',
                    folderId: config ? config.folderId : 'undefined'
                };
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ AuthService
                if (window.authService) {
                    diagnostic.authService = {
                        isInitialized: window.authService.isInitialized,
                        isSignedIn: window.authService.isSignedIn(),
                        hasUser: !!window.authService.getUser(),
                        hasToken: !!window.authService.getAccessToken(),
                        userName: window.authService.getUserName(),
                        authState: window.authService.authState || 'undefined'
                    };
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ localStorage
                diagnostic.localStorage = {
                    hasGoogleAuthState: localStorage.getItem('google_auth_state') !== null,
                    googleAuthState: localStorage.getItem('google_auth_state') ? 
                        JSON.parse(localStorage.getItem('google_auth_state')) : null
                };
                
                // –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
                if (diagnostic.environment.hasAuthService) {
                    addDebugItem('‚úÖ AuthService', 'pass', 'AuthService –¥–æ—Å—Ç—É–ø–µ–Ω');
                } else {
                    addDebugItem('‚ùå AuthService', 'fail', 'AuthService –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                }
                
                if (diagnostic.authService.isSignedIn) {
                    addDebugItem('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', 'pass', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                } else {
                    addDebugItem('‚ùå –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', 'fail', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                }
                
                if (diagnostic.authService.hasToken) {
                    addDebugItem('‚úÖ –¢–æ–∫–µ–Ω', 'pass', '–¢–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ –Ω–∞–π–¥–µ–Ω');
                } else {
                    addDebugItem('‚ùå –¢–æ–∫–µ–Ω', 'fail', '–¢–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');
                }
                
                if (diagnostic.localStorage.hasGoogleAuthState) {
                    addDebugItem('‚úÖ localStorage', 'pass', '–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ localStorage');
                } else {
                    addDebugItem('‚ùå localStorage', 'fail', '–°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ localStorage');
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                updateDetailedInfo(diagnostic);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                if (diagnostic.authService.isSignedIn && diagnostic.authService.hasToken) {
                    updateStatus('‚úÖ –í—Å–µ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ', 'success');
                } else {
                    updateStatus('‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π', 'warning');
                }
                
            } catch (error) {
                addDebugItem('‚ùå –û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏', 'fail', error.message);
                diagnostic.errors.push(error.message);
                updateDetailedInfo(diagnostic);
            }
        }
        
        function checkAuthState() {
            if (!window.authService) {
                addDebugItem('‚ùå AuthService', 'fail', 'AuthService –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                return;
            }
            
            const isSignedIn = window.authService.isSignedIn();
            const user = window.authService.getUser();
            const token = window.authService.getAccessToken();
            const userName = window.authService.getUserName();
            
            addDebugItem('üîë –°–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', isSignedIn ? 'pass' : 'fail', 
                `–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: ${isSignedIn}<br>
                 –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userName || '–Ω–µ—Ç'}<br>
                 –¢–æ–∫–µ–Ω: ${token ? '–µ—Å—Ç—å' : '–Ω–µ—Ç'}<br>
                 –¢–æ–∫–µ–Ω (–ø–µ—Ä–≤—ã–µ 20 —Å–∏–º–≤–æ–ª–æ–≤): ${token ? token.substring(0, 20) + '...' : '–Ω–µ—Ç'}`);
        }
        
        function checkLocalStorage() {
            const authState = localStorage.getItem('google_auth_state');
            
            if (authState) {
                try {
                    const parsed = JSON.parse(authState);
                    addDebugItem('üíæ localStorage', 'pass', 
                        `–°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ<br>
                         –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: ${parsed.isSignedIn}<br>
                         –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${parsed.user ? parsed.user.name : '–Ω–µ—Ç'}<br>
                         –¢–æ–∫–µ–Ω: ${parsed.accessToken ? '–µ—Å—Ç—å' : '–Ω–µ—Ç'}<br>
                         –í—Ä–µ–º—è: ${new Date(parsed.timestamp).toLocaleString()}`);
                } catch (error) {
                    addDebugItem('üíæ localStorage', 'fail', '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ' + error.message);
                }
            } else {
                addDebugItem('üíæ localStorage', 'fail', '–°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
            }
        }
        
        function clearAll() {
            localStorage.removeItem('google_auth_state');
            document.getElementById('diagnostic-results').innerHTML = '';
            document.getElementById('detailed-info').textContent = '–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã';
            updateStatus('üóëÔ∏è –í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã', 'info');
        }
    </script>
</body>
</html>
