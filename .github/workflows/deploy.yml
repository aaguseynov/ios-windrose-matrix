name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: github-pages
    permissions:
      contents: write
      pages: write
      id-token: write
    env:
      CLIENT_ID: ${{ secrets.CLIENT_ID }}
      CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
      PROJECT_ID: ${{ secrets.PROJECT_ID }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Test Environment Variables
      run: |
        echo "=== ПРОВЕРКА ПЕРЕМЕННЫХ ОКРУЖЕНИЯ ==="
        echo "CLIENT_ID: ${{ env.CLIENT_ID }}"
        echo "CLIENT_SECRET: ${{ env.CLIENT_SECRET }}"
        echo "PROJECT_ID: ${{ env.PROJECT_ID }}"
        echo "=== ПРОВЕРКА SECRETS ==="
        echo "CLIENT_ID from secrets: ${{ secrets.CLIENT_ID }}"
        echo "CLIENT_SECRET from secrets: ${{ secrets.CLIENT_SECRET }}"
        echo "PROJECT_ID from secrets: ${{ secrets.PROJECT_ID }}"
        echo "=== ПРОВЕРКА ВСЕХ ENV ==="
        env | grep -i client || echo "No CLIENT variables found"
        env | grep -i project || echo "No PROJECT variables found"
        
    - name: Create Environment File
      run: |
        echo "Создаем env-vars.js с переменными окружения..."
        echo "CLIENT_ID: ${{ env.CLIENT_ID }}"
        echo "CLIENT_SECRET: ${{ env.CLIENT_SECRET }}"
        echo "PROJECT_ID: ${{ env.PROJECT_ID }}"
        
        # Создаем файл env-vars.js
        cat > env-vars.js << 'EOF'
        // Переменные окружения для Google Drive API
        // Этот файл создается автоматически во время деплоя
        
        window.CLIENT_ID = 'CLIENT_ID_PLACEHOLDER';
        window.CLIENT_SECRET = 'CLIENT_SECRET_PLACEHOLDER';
        window.PROJECT_ID = 'PROJECT_ID_PLACEHOLDER';
        window.GOOGLE_DRIVE_FOLDER_ID = '14RzE0Souwr-gzb5D0sNqsPH6nMI0J3Ae';
        window.GOOGLE_DRIVE_FOLDER_URL = 'https://drive.google.com/drive/folders/14RzE0Souwr-gzb5D0sNqsPH6nMI0J3Ae?usp=drive_link';
        EOF
        
        # Заменяем плейсхолдеры на реальные значения
        sed -i "s/CLIENT_ID_PLACEHOLDER/${{ env.CLIENT_ID }}/g" env-vars.js
        sed -i "s/CLIENT_SECRET_PLACEHOLDER/${{ env.CLIENT_SECRET }}/g" env-vars.js
        sed -i "s/PROJECT_ID_PLACEHOLDER/${{ env.PROJECT_ID }}/g" env-vars.js
        
        echo "Проверяем создание env-vars.js:"
        ls -la env-vars.js
        echo "Содержимое env-vars.js:"
        cat env-vars.js
        
    - name: Verify Files Before Upload
      run: |
        echo "Содержимое папки перед загрузкой:"
        ls -la
        echo "Проверяем содержимое evaluation.html:"
        grep -A 3 -B 1 "env-vars.js" evaluation.html || echo "env-vars.js не найден в evaluation.html"
        echo "Проверяем env-vars.js:"
        if [ -f "env-vars.js" ]; then
          echo "✅ env-vars.js найден"
          echo "Размер файла: $(wc -c < env-vars.js) байт"
          echo "Права доступа: $(ls -la env-vars.js)"
          echo "Содержимое env-vars.js:"
          cat env-vars.js
        else
          echo "❌ env-vars.js НЕ найден!"
        fi
        
        # Дополнительная проверка - создаем тестовый файл
        echo "Создаем тестовый файл для проверки:"
        echo "test content" > test-file.txt
        ls -la test-file.txt
        
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Verify Deployment
      run: |
        echo "Деплой завершен. Переменные встроены в evaluation.html:"
        echo "evaluation.html: https://aaguseynov.github.io/ios-windrose-matrix/evaluation.html"
        echo "Проверьте работу Google Drive API на странице!"
