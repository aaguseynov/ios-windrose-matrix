name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: github-pages
    permissions:
      contents: read
      pages: write
      id-token: write
    env:
      CLIENT_ID: ${{ secrets.CLIENT_ID }}
      CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
      PROJECT_ID: ${{ secrets.PROJECT_ID }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Inject Environment Variables
      run: |
        # Создаем файл с переменными окружения для браузера
        cat > env-config.js << EOF
        window.CLIENT_ID = '${{ env.CLIENT_ID }}';
        window.CLIENT_SECRET = '${{ env.CLIENT_SECRET }}';
        window.PROJECT_ID = '${{ env.PROJECT_ID }}';
        window.GOOGLE_DRIVE_FOLDER_ID = '14RzE0Souwr-gzb5D0sNqsPH6nMI0J3Ae';
        window.GOOGLE_DRIVE_FOLDER_URL = 'https://drive.google.com/drive/folders/14RzE0Souwr-gzb5D0sNqsPH6nMI0J3Ae?usp=drive_link';
        EOF
        
        # Создаем также файл с другим расширением для тестирования
        cp env-config.js env-config.txt
        
        # Проверяем, что файл создался
        echo "Проверяем создание env-config.js:"
        ls -la env-config.js
        echo "Содержимое файла:"
        cat env-config.js
        
    - name: Verify Files Before Upload
      run: |
        echo "Содержимое папки перед загрузкой:"
        ls -la
        echo "Проверяем env-config.js:"
        if [ -f "env-config.js" ]; then
          echo "✅ env-config.js найден"
          echo "Размер файла: $(wc -c < env-config.js) байт"
          echo "Права доступа: $(ls -la env-config.js)"
        else
          echo "❌ env-config.js НЕ найден!"
        fi
        
        # Дополнительная проверка - создаем тестовый файл
        echo "Создаем тестовый файл для проверки:"
        echo "test content" > test-file.txt
        ls -la test-file.txt
        
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Verify Deployment
      run: |
        echo "Деплой завершен. Проверьте доступность файлов:"
        echo "env-config.js: https://aaguseynov.github.io/ios-windrose-matrix/env-config.js"
        echo "env-config.txt: https://aaguseynov.github.io/ios-windrose-matrix/env-config.txt"
        echo "test-file.txt: https://aaguseynov.github.io/ios-windrose-matrix/test-file.txt"
        echo "evaluation.html: https://aaguseynov.github.io/ios-windrose-matrix/evaluation.html"
