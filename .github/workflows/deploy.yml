name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: github-pages
    permissions:
      contents: read
      pages: write
      id-token: write
    env:
      CLIENT_ID: ${{ secrets.CLIENT_ID }}
      CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
      PROJECT_ID: ${{ secrets.PROJECT_ID }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Inject Environment Variables
      run: |
        # Встраиваем переменные прямо в evaluation.html
        echo "Встраиваем переменные в evaluation.html..."
        
        # Заменяем строку в evaluation.html
        sed -i 's|<script src="env-vars.html"></script>|<script>window.CLIENT_ID = "${{ env.CLIENT_ID }}"; window.CLIENT_SECRET = "${{ env.CLIENT_SECRET }}"; window.PROJECT_ID = "${{ env.PROJECT_ID }}"; window.GOOGLE_DRIVE_FOLDER_ID = "14RzE0Souwr-gzb5D0sNqsPH6nMI0J3Ae"; window.GOOGLE_DRIVE_FOLDER_URL = "https://drive.google.com/drive/folders/14RzE0Souwr-gzb5D0sNqsPH6nMI0J3Ae?usp=drive_link";</script>|g' evaluation.html
        
        # Проверяем результат
        echo "Проверяем встроенные переменные:"
        grep -A 2 -B 2 "window.CLIENT_ID" evaluation.html || echo "Переменные не найдены"
        
    - name: Verify Files Before Upload
      run: |
        echo "Содержимое папки перед загрузкой:"
        ls -la
        echo "Проверяем env-config.js:"
        if [ -f "env-config.js" ]; then
          echo "✅ env-config.js найден"
          echo "Размер файла: $(wc -c < env-config.js) байт"
          echo "Права доступа: $(ls -la env-config.js)"
        else
          echo "❌ env-config.js НЕ найден!"
        fi
        
        # Дополнительная проверка - создаем тестовый файл
        echo "Создаем тестовый файл для проверки:"
        echo "test content" > test-file.txt
        ls -la test-file.txt
        
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Verify Deployment
      run: |
        echo "Деплой завершен. Переменные встроены в evaluation.html:"
        echo "evaluation.html: https://aaguseynov.github.io/ios-windrose-matrix/evaluation.html"
        echo "Проверьте работу Google Drive API на странице!"
